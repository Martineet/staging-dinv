<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D.Inversions - Bitcoin Portfolio</title>

    <!-- âœ… Supabase JS SDK (loaded from CDN, no build step needed) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: #0a0e27;
            min-height: 100vh;
            color: #e5e7eb;
            padding: 20px;
        }

        .container {
            background: #1a1d2e;
            border-radius: 16px;
            border: 1px solid #2d3548;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px;
            position: relative;
        }

        h1 { color: #ffffff; margin-bottom: 10px; font-size: 2em; font-weight: 600; }
        .subtitle { color: #9ca3af; margin-bottom: 30px; font-size: 16px; }

        /* â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .login-form { max-width: 400px; margin: 0 auto; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #e5e7eb; font-weight: 500; font-size: 14px; }
        input, select {
            width: 100%; padding: 12px 16px;
            background: #0a0e27; border: 1px solid #2d3548;
            border-radius: 8px; font-size: 16px; color: #e5e7eb; transition: all 0.3s;
        }
        input:focus, select:focus { outline: none; border-color: #f59e0b; background: #141829; }
        button {
            width: 100%; padding: 14px;
            background: #f59e0b; color: #0a0e27;
            border: none; border-radius: 8px;
            font-size: 16px; font-weight: 600;
            cursor: pointer; transition: all 0.3s; letter-spacing: 0.5px;
        }
        button:hover { background: #d97706; transform: translateY(-1px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .error { color: #ef4444; margin-top: 10px; font-size: 14px; }
        .info-msg { color: #10b981; margin-top: 10px; font-size: 14px; }

        /* â”€â”€ Calculator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .calculator-section { max-width: 500px; margin: 0 auto 40px; }
        .calculator-card { background: #0a0e27; border: 1px solid #2d3548; border-radius: 12px; padding: 24px; }
        .calc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .calc-row label { display: block; margin-bottom: 8px; color: #9ca3af; font-size: 13px; font-weight: 500; }
        .calc-row input { width: 100%; padding: 12px; border: 1px solid #2d3548; border-radius: 8px; font-size: 16px; transition: all 0.3s; }
        .calc-row input:focus { outline: none; border-color: #f59e0b; }
        .calc-result { margin-top: 30px; padding: 20px; background: linear-gradient(135deg, rgba(245,158,11,.1) 0%, rgba(245,158,11,.05) 100%); border: 1px solid #f59e0b; border-radius: 12px; text-align: center; }
        .result-label { color: #9ca3af; font-size: 13px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .result-value { color: #f59e0b; font-size: 32px; font-weight: 700; }

        /* â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .summary-section { margin-bottom: 40px; }
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 800px; margin: 0 auto; }
        .summary-card { background: #0a0e27; border: 1px solid #2d3548; border-radius: 12px; padding: 20px; text-align: center; transition: all 0.3s; }
        .summary-card:hover { border-color: #f59e0b; transform: translateY(-2px); }
        .summary-card.highlight { border-color: #f59e0b; background: linear-gradient(135deg, rgba(245,158,11,.1) 0%, rgba(245,158,11,.05) 100%); }
        .summary-icon { font-size: 28px; margin-bottom: 10px; }
        .summary-value { font-size: 20px; font-weight: 700; color: #ffffff; margin-bottom: 5px; }
        .summary-label { font-size: 11px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; }

        /* â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid #2d3548; }
        .welcome { font-size: 1.5em; color: #ffffff; font-weight: 600; }

        /* â”€â”€ Settings menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .settings-wrapper { position: relative; }
        .settings-btn {
            width: auto; padding: 8px 12px;
            background: transparent; border: 1px solid #2d3548;
            border-radius: 10px; font-size: 22px; line-height: 1;
            cursor: pointer; transition: all 0.2s; color: #e5e7eb;
        }
        .settings-btn:hover { border-color: #f59e0b; background: rgba(245,158,11,.08); transform: none; }
        .settings-dropdown {
            display: none;
            position: absolute; right: 0; top: calc(100% + 8px);
            background: #1a1d2e; border: 1px solid #2d3548;
            border-radius: 10px; min-width: 190px;
            box-shadow: 0 8px 24px rgba(0,0,0,.4);
            overflow: hidden; z-index: 100;
        }
        .settings-dropdown.open { display: block; }
        .settings-item {
            width: 100%; padding: 13px 18px;
            background: transparent; border: none; border-radius: 0;
            text-align: left; font-size: 14px; font-weight: 500;
            color: #e5e7eb; cursor: pointer; display: flex; align-items: center; gap: 10px;
            transition: background 0.15s; letter-spacing: 0;
        }
        .settings-item:hover { background: rgba(255,255,255,.06); transform: none; }
        .settings-item.danger { color: #ef4444; }
        .settings-item.danger:hover { background: rgba(239,68,68,.1); }
        .settings-divider { height: 1px; background: #2d3548; margin: 0; }

        /* â”€â”€ Change-password modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,.6); backdrop-filter: blur(4px);
            z-index: 200; align-items: center; justify-content: center;
        }
        .modal-overlay.open { display: flex; }
        .modal {
            background: #1a1d2e; border: 1px solid #2d3548;
            border-radius: 16px; padding: 36px; width: 100%; max-width: 400px;
            box-shadow: 0 16px 48px rgba(0,0,0,.5);
        }
        .modal h3 { color: #ffffff; font-size: 1.1em; margin-bottom: 24px; }
        .modal .form-group { margin-bottom: 18px; }
        .modal-actions { display: flex; gap: 10px; margin-top: 8px; }
        .modal-actions button { flex: 1; }
        .btn-secondary {
            background: transparent; border: 1px solid #2d3548; color: #e5e7eb;
        }
        .btn-secondary:hover { background: rgba(255,255,255,.06); transform: none; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: #0a0e27; border: 1px solid #2d3548; padding: 24px; border-radius: 12px; transition: all 0.3s; }
        .stat-card:hover { border-color: #f59e0b; transform: translateY(-2px); }
        .stat-card.highlight { border-color: #f59e0b; background: linear-gradient(135deg, rgba(245,158,11,.1) 0%, rgba(245,158,11,.05) 100%); }
        .stat-label { font-size: 13px; color: #9ca3af; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500; }
        .stat-value { font-size: 28px; font-weight: 700; color: #ffffff; }
        .investments-table { background: #0a0e27; border: 1px solid #2d3548; border-radius: 12px; padding: 24px; overflow-x: auto; }
        .investments-table h2 { color: #ffffff; font-size: 18px; margin-bottom: 20px; font-weight: 600; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; color: #9ca3af; font-weight: 600; font-size: 13px; border-bottom: 1px solid #2d3548; text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: 16px 12px; border-bottom: 1px solid #2d3548; color: #e5e7eb; font-size: 14px; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: rgba(245,158,11,.05); }
        .positive { color: #10b981; font-weight: 600; }
        .negative { color: #ef4444; font-weight: 600; }
        .loading { text-align: center; padding: 40px; color: #9ca3af; }

        /* â”€â”€ Logos / Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .btc-logo { position: absolute; bottom: 20px; right: 20px; width: 50px; height: 50px; opacity: 0.6; transition: opacity 0.3s; }
        .btc-logo:hover { opacity: 1; }
        .btc-logo img { width: 100%; height: 100%; object-fit: contain; }
        .dinversions-logo { position: absolute; bottom: 20px; left: 20px; width: 60px; height: 60px; background: #ffffff; border-radius: 50%; padding: 0; box-shadow: 0 4px 12px rgba(0,0,0,.3); overflow: hidden; transition: all 0.3s; }
        .dinversions-logo:hover { transform: scale(1.05); box-shadow: 0 6px 16px rgba(245,158,11,.4); }
        .dinversions-logo img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #2d3548; text-align: center; color: #6b7280; font-size: 13px; }
        .footer a { color: #f59e0b; text-decoration: none; }
        .footer a:hover { text-decoration: underline; }

        @media (max-width: 600px) {
            .container { padding: 20px; }
            h1 { font-size: 1.5em; }
            #headerBtcPrice { font-size: 1.3em !important; }
            .stats-grid { grid-template-columns: 1fr; }
            .summary-grid { grid-template-columns: repeat(2, 1fr); }
            .calc-grid { grid-template-columns: 1fr; }
            .calculator-card { padding: 16px; }
            .result-value { font-size: 24px; }
            .btc-logo { width: 40px; height: 40px; }
            .dinversions-logo { width: 50px; height: 50px; }
            table { font-size: 12px; }
            th, td { padding: 8px; }
        }
    </style>
</head>
<body>
<div class="container">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         LOGIN PAGE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="loginPage" class="login-page">
        <div style="margin-bottom: 30px;">
            <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:10px;">
                <h1 style="margin:0;">ğŸª™ D.Inversions</h1>
                <div id="headerBtcPrice" style="color:#f59e0b; font-size:2em; font-weight:600; margin:0;">-- â‚¬</div>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:baseline;">
                <p class="subtitle" style="margin:0;">Track your Bitcoin investments</p>
                <p class="subtitle" style="margin:0; text-align:right;">Bitcoin price</p>
            </div>
        </div>

        <!-- Login Form -->
        <div style="margin-bottom: 40px;">
            <h2 style="color:#ffffff; font-size:1.1em; margin-bottom:20px; text-align:center;">ğŸ” Member Login</h2>
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required placeholder="your@email.com" autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required placeholder="Enter your password" autocomplete="off">
                </div>
                <button type="submit" id="loginBtn">Login</button>
                <div class="error" id="loginError"></div>
                <div class="info-msg" id="loginInfo"></div>
            </form>
        </div>

        <!-- Portfolio Summary (public, aggregated â€” no personal data) -->
        <div class="summary-section" style="padding-top:30px; border-top:1px solid #2d3548;">
            <h2 style="color:#ffffff; font-size:1.3em; margin-bottom:15px; text-align:center;">ğŸ“Š D.Inversions Portfolio</h2>
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-icon">â‚¿</div>
                    <div class="summary-value" id="summaryTotalBTC">-- BTC</div>
                    <div class="summary-label">Bitcoin Hodled</div>
                </div>
                <div class="summary-card">
                    <div class="summary-icon">ğŸ‘¥</div>
                    <div class="summary-value" id="summaryBitcoiners">--</div>
                    <div class="summary-label">Bitcoiners</div>
                </div>
                <div class="summary-card">
                    <div class="summary-icon">ğŸ’µ</div>
                    <div class="summary-value" id="summaryTheoreticalValue">-- â‚¬</div>
                    <div class="summary-label">Real Time Value</div>
                </div>
                <div class="summary-card">
                    <div class="summary-icon">ğŸ’°</div>
                    <div class="summary-value" id="summaryTotalInvestment">-- â‚¬</div>
                    <div class="summary-label">Total Invested</div>
                </div>
                <div class="summary-card highlight">
                    <div class="summary-icon">ğŸ“ˆ</div>
                    <div class="summary-value" id="summaryResult" style="color:#f59e0b;">-- â‚¬</div>
                    <div class="summary-label">Portfolio Result</div>
                </div>
                <div class="summary-card">
                    <div class="summary-icon">ğŸ›¡ï¸</div>
                    <div class="summary-value" id="summaryGuaranteed">-- â‚¬</div>
                    <div class="summary-label">Guaranteed Amount</div>
                </div>
            </div>
        </div>

        <!-- Bitcoin Investment Calculator -->
        <div class="calculator-section" style="margin-top:40px; padding-top:30px; border-top:1px solid #2d3548;">
            <h2 style="color:#ffffff; font-size:1.3em; margin-bottom:15px; text-align:center;">ğŸ’° Bitcoin Investment Calculator</h2>
            <div class="calculator-card">
                <div class="calc-grid">
                    <div class="calc-row">
                        <label>Current BTC Price</label>
                        <input type="text" id="calcCurrentPrice" readonly style="background:#0a0e27; color:#9ca3af;">
                    </div>
                    <div class="calc-row">
                        <label>Annual Growth Rate (%)</label>
                        <input type="number" id="calcGrowthRate" value="20" min="0" max="1000" style="background:#0a0e27; color:#ffffff;">
                    </div>
                    <div class="calc-row">
                        <label>Investment Amount (â‚¬)</label>
                        <input type="number" id="calcInvestment" placeholder="1000" min="0" style="background:#0a0e27; color:#ffffff;">
                    </div>
                    <div class="calc-row">
                        <label>Expected BTC Price (4 years)</label>
                        <input type="number" id="calcFuturePrice" style="background:#0a0e27; color:#f59e0b; font-weight:600;">
                    </div>
                </div>
                <div class="calc-result">
                    <div class="result-label">Expected Final Value (4 years)</div>
                    <div class="result-value" id="calcFinalValue">-- â‚¬</div>
                </div>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         DASHBOARD (shown after login)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="dashboard" class="dashboard">
        <div class="header">
            <h1 class="welcome">Welcome, <span id="userName"></span>!</h1>
            <div class="settings-wrapper">
                <button class="settings-btn" id="settingsBtn" title="Settings">âš™ï¸</button>
                <div class="settings-dropdown" id="settingsDropdown">
                    <button class="settings-item" onclick="openChangePassword()">ğŸ”‘ Change Password</button>
                    <div class="settings-divider"></div>
                    <button class="settings-item danger" onclick="logout()">ğŸšª Logout</button>
                </div>
            </div>
        </div>

        <!-- Change Password Modal -->
        <div class="modal-overlay" id="changePasswordModal">
            <div class="modal">
                <h3>ğŸ”‘ Change Password</h3>
                <div class="form-group">
                    <label for="newPassword">New password</label>
                    <input type="password" id="newPassword" placeholder="At least 6 characters" autocomplete="new-password">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm new password</label>
                    <input type="password" id="confirmPassword" placeholder="Repeat password" autocomplete="new-password">
                </div>
                <div class="error" id="pwError"></div>
                <div class="info-msg" id="pwSuccess"></div>
                <div class="modal-actions">
                    <button class="btn-secondary" onclick="closeChangePassword()">Cancel</button>
                    <button id="savePwBtn" onclick="saveNewPassword()">Save</button>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Current BTC Price</div>
                <div class="stat-value" id="btcPrice">-- â‚¬</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Invested</div>
                <div class="stat-value" id="totalInvested">-- â‚¬</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Current Value</div>
                <div class="stat-value" id="currentValue">-- â‚¬</div>
            </div>
            <div class="stat-card highlight">
                <div class="stat-label">ğŸ›¡ï¸ Guaranteed Investment</div>
                <div class="stat-value" id="guaranteedAmount" style="color:#f59e0b;">-- â‚¬</div>
            </div>
            <div class="stat-card highlight">
                <div class="stat-label">ğŸ’° Final Value</div>
                <div class="stat-value" id="finalValue" style="color:#f59e0b;">-- â‚¬</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Result</div>
                <div class="stat-value" id="profitLoss">-- â‚¬</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ’¸ Total Commissions</div>
                <div class="stat-value" id="totalCommissions">-- â‚¬</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ§¾ Total Taxes</div>
                <div class="stat-value" id="totalTaxes">-- â‚¬</div>
            </div>
        </div>

        <div class="investments-table">
            <h2>Your Investments</h2>
            <div id="tableContent">
                <div class="loading">Loading your investmentsâ€¦</div>
            </div>
        </div>
    </div>

    <!-- Logos -->
    <div class="dinversions-logo"><img src="log1.png" alt="D.Inversions Logo"></div>
    <div class="btc-logo"><img src="https://cryptologos.cc/logos/bitcoin-btc-logo.svg" alt="Bitcoin Logo"></div>

    <div class="footer">
        <p>&copy; 2026 <strong>D.Inversions</strong> â€” All rights reserved</p>
        <p style="margin-top:5px;">Bitcoin Portfolio Tracker | Powered by <a href="https://www.coingecko.com" target="_blank">CoinGecko API</a></p>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  âš™ï¸  CONFIGURATION  â€” replace with YOUR Supabase values
//      (these are safe to commit; they are PUBLIC keys)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPABASE_URL  = 'https://YOUR_PROJECT_REF.supabase.co';   // e.g. https://abcdefghij.supabase.co
const SUPABASE_ANON = 'YOUR_ANON_PUBLIC_KEY';                    // Project Settings â†’ API â†’ anon public

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Supabase client (global, reused everywhere)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Constants
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TAX_RATE          = 0.21;
const DEFAULT_GROWTH    = 20;   // % annual

let currentBTCPrice = 0;
let currentSession  = null;   // Supabase session object

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Auth state listener â€” runs on every page load + change
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
sb.auth.onAuthStateChange(async (event, session) => {
    currentSession = session;

    if (session) {
        // User is logged in
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('dashboard').classList.add('active');
        document.getElementById('userName').textContent = session.user.email;
        await loadDashboard(session.user);
    } else {
        // User is logged out
        document.getElementById('loginPage').style.display = 'block';
        document.getElementById('dashboard').classList.remove('active');
    }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Login handler
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email    = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const errorDiv = document.getElementById('loginError');
    const infoDiv  = document.getElementById('loginInfo');
    const btn      = document.getElementById('loginBtn');

    errorDiv.textContent = '';
    infoDiv.textContent  = '';
    btn.disabled = true;
    btn.textContent = 'Logging inâ€¦';

    const { error } = await sb.auth.signInWithPassword({ email, password });

    btn.disabled = false;
    btn.textContent = 'Login';

    if (error) {
        errorDiv.textContent = error.message;
    }
    // On success, onAuthStateChange fires automatically â†’ dashboard opens
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Logout
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function logout() {
    await sb.auth.signOut();
    // onAuthStateChange fires â†’ login page shown
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Settings dropdown toggle
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('click', (e) => {
    const btn      = document.getElementById('settingsBtn');
    const dropdown = document.getElementById('settingsDropdown');
    if (!btn || !dropdown) return;
    if (btn.contains(e.target)) {
        dropdown.classList.toggle('open');
    } else if (!dropdown.contains(e.target)) {
        dropdown.classList.remove('open');
    }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Change Password modal
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openChangePassword() {
    document.getElementById('settingsDropdown').classList.remove('open');
    document.getElementById('newPassword').value    = '';
    document.getElementById('confirmPassword').value = '';
    document.getElementById('pwError').textContent   = '';
    document.getElementById('pwSuccess').textContent = '';
    document.getElementById('changePasswordModal').classList.add('open');
    document.getElementById('newPassword').focus();
}

function closeChangePassword() {
    document.getElementById('changePasswordModal').classList.remove('open');
}

// Close modal on overlay click
document.getElementById('changePasswordModal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) closeChangePassword();
});

async function saveNewPassword() {
    const newPw     = document.getElementById('newPassword').value;
    const confirmPw = document.getElementById('confirmPassword').value;
    const errEl     = document.getElementById('pwError');
    const okEl      = document.getElementById('pwSuccess');
    const btn       = document.getElementById('savePwBtn');

    errEl.textContent = '';
    okEl.textContent  = '';

    if (newPw.length < 6) {
        errEl.textContent = 'Password must be at least 6 characters.';
        return;
    }
    if (newPw !== confirmPw) {
        errEl.textContent = 'Passwords do not match.';
        return;
    }

    btn.disabled    = true;
    btn.textContent = 'Savingâ€¦';

    const { error } = await sb.auth.updateUser({ password: newPw });

    btn.disabled    = false;
    btn.textContent = 'Save';

    if (error) {
        errEl.textContent = error.message;
    } else {
        okEl.textContent = 'âœ… Password updated! Signing you outâ€¦';
        // Supabase invalidates the session on password change.
        // We sign out explicitly so onAuthStateChange fires cleanly
        // and the user is sent back to the login page.
        setTimeout(async () => {
            closeChangePassword();
            await sb.auth.signOut();
        }, 1800);
    }
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchBTCPrice() {
    try {
        const res  = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=eur');
        const data = await res.json();
        currentBTCPrice = data.bitcoin.eur;

        const fmt = currentBTCPrice.toLocaleString('de-DE') + ' â‚¬';
        if (document.getElementById('btcPrice'))
            document.getElementById('btcPrice').textContent = fmt;
        if (document.getElementById('headerBtcPrice'))
            document.getElementById('headerBtcPrice').textContent = Math.round(currentBTCPrice).toLocaleString('de-DE') + ' â‚¬';
    } catch (err) {
        console.error('BTC price fetch failed:', err);
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Load dashboard â€” fetches investments for logged-in user
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboard(user) {
    await fetchBTCPrice();

    // RLS ensures this query only returns rows where client_id matches the user.
    // We join on clients table to get the client_id from the user's email.
    const { data: clientData, error: clientError } = await sb
        .from('clients')
        .select('client_id, display_name')
        .eq('email', user.email)
        .single();

    if (clientError || !clientData) {
        document.getElementById('tableContent').innerHTML =
            '<p style="text-align:center; color:#ef4444;">Could not find your account. Contact the administrator.</p>';
        console.error('Client lookup error:', clientError);
        return;
    }

    // Show display name instead of email
    document.getElementById('userName').textContent = clientData.display_name;

    const { data: investments, error: invError } = await sb
        .from('investments')
        .select('*')
        .eq('client_id', clientData.client_id)
        .order('date_swap', { ascending: true });

    if (invError) {
        document.getElementById('tableContent').innerHTML =
            '<p style="text-align:center; color:#ef4444;">Error loading investments.</p>';
        console.error('Investments fetch error:', invError);
        return;
    }

    renderInvestments(investments);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Render investments table + summary cards
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderInvestments(investments) {
    if (!investments || investments.length === 0) {
        document.getElementById('tableContent').innerHTML =
            '<p style="text-align:center; color:#9ca3af;">No investments yet.</p>';
        resetStatCards();
        return;
    }

    let totalInvested = 0, totalBTC = 0, totalGuaranteed = 0;
    let totalFinalValue = 0, totalCommissionsSum = 0, totalTaxesSum = 0;

    let tableHTML = `
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>BTC Amount</th>
                    <th>EUR Invested</th>
                    <th>Purchase Price</th>
                    <th>Current Value</th>
                    <th>Commission</th>
                    <th>Profit/Loss</th>
                    <th>Guaranteed</th>
                    <th>Guarantee Date</th>
                </tr>
            </thead>
            <tbody>`;

    investments.forEach(inv => {
        const btcAmount      = parseFloat(inv.btc_amount);
        const eurAmount      = parseFloat(inv.eur_amount);
        const purchasePrice  = parseFloat(inv.purchase_price);
        const commission     = parseFloat(inv.commission);
        const guaranteed     = inv.guaranteed;

        const rawCurrentValue = btcAmount * currentBTCPrice;
        const currentValue    = rawCurrentValue * 0.99;  // conservative 1% haircut
        const profitLoss      = currentValue - eurAmount;

        let commissionFlat = 0, taxes = 0, finalValue = currentValue;

        if (currentValue > eurAmount) {
            const profit          = currentValue - eurAmount;
            commissionFlat        = profit * commission;
            const afterCommission = currentValue - commissionFlat;
            const taxableProfit   = afterCommission - eurAmount;
            taxes                 = taxableProfit * TAX_RATE;
            finalValue            = afterCommission - taxes;
        } else if (guaranteed && finalValue < eurAmount) {
            finalValue = eurAmount;
        }

        totalInvested       += eurAmount;
        totalBTC            += btcAmount;
        totalFinalValue     += finalValue;
        totalCommissionsSum += commissionFlat;
        totalTaxesSum       += taxes;
        if (guaranteed) totalGuaranteed += eurAmount;

        const purchaseDate   = new Date(inv.date_swap);
        const guaranteeDate  = new Date(purchaseDate);
        guaranteeDate.setFullYear(guaranteeDate.getFullYear() + 4);
        const guaranteeDateStr = guaranteeDate.toISOString().split('T')[0];

        const plClass  = profitLoss >= 0 ? 'positive' : 'negative';
        const plSign   = profitLoss >= 0 ? '+' : '';
        const commPct  = (commission * 100).toFixed(0) + '%';
        const guarIcon = guaranteed ? 'âœ… Yes' : 'âŒ No';

        tableHTML += `
            <tr>
                <td>${inv.date_swap}</td>
                <td>${btcAmount.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 5 })} BTC</td>
                <td>${fmt(eurAmount)} â‚¬</td>
                <td>${purchasePrice.toLocaleString('de-DE')} â‚¬</td>
                <td>${fmt(currentValue)} â‚¬</td>
                <td style="text-align:center;">${commPct}</td>
                <td class="${plClass}">${plSign}${fmt(profitLoss)} â‚¬</td>
                <td style="text-align:center;">${guarIcon}</td>
                <td>${guaranteed ? guaranteeDateStr : '-'}</td>
            </tr>`;
    });

    tableHTML += '</tbody></table>';
    document.getElementById('tableContent').innerHTML = tableHTML;

    // Totals
    const totalCurrentValue = totalBTC * currentBTCPrice * 0.99;
    const totalProfitLoss   = totalCurrentValue - totalInvested;

    // Global loss protection
    if (totalCurrentValue < totalInvested) {
        totalCommissionsSum = 0;
        totalTaxesSum       = 0;
        totalFinalValue     = totalCurrentValue;
    }

    // Guarantee protection pass
    investments.forEach(inv => {
        if (inv.guaranteed) {
            const cv = parseFloat(inv.btc_amount) * currentBTCPrice * 0.99;
            const eu = parseFloat(inv.eur_amount);
            if (cv < eu) totalFinalValue += (eu - cv);
        }
    });

    document.getElementById('totalInvested').textContent  = fmt(totalInvested) + ' â‚¬';
    document.getElementById('currentValue').textContent   = fmt(totalCurrentValue) + ' â‚¬';
    document.getElementById('finalValue').textContent     = fmt(totalFinalValue) + ' â‚¬';
    document.getElementById('totalCommissions').textContent = fmt(totalCommissionsSum) + ' â‚¬';
    document.getElementById('totalTaxes').textContent     = fmt(totalTaxesSum) + ' â‚¬';
    document.getElementById('guaranteedAmount').textContent = fmt(totalGuaranteed) + ' â‚¬';

    const plEl   = document.getElementById('profitLoss');
    const plSign = totalProfitLoss >= 0 ? '+' : '';
    plEl.textContent  = plSign + fmt(totalProfitLoss) + ' â‚¬';
    plEl.style.color  = totalProfitLoss >= 0 ? '#10b981' : '#ef4444';
}

function resetStatCards() {
    ['totalInvested','currentValue','finalValue','totalCommissions',
     'totalTaxes','guaranteedAmount','profitLoss'].forEach(id => {
        document.getElementById(id).textContent = '-- â‚¬';
    });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Portfolio summary (landing page â€” aggregated data)
//  Uses a Postgres RPC function that bypasses RLS safely.
//  See SETUP_GUIDE.md for the SQL to create it.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPortfolioSummary() {
    const { data, error } = await sb.rpc('get_portfolio_summary');
    if (error || !data) {
        console.warn('Portfolio summary unavailable:', error);
        return;
    }
    const { total_btc, total_invested, total_guaranteed, bitcoiners } = data;
    const totalVolume   = total_btc * currentBTCPrice;
    const portfolioResult = totalVolume - total_invested;

    document.getElementById('summaryTotalBTC').textContent        = parseFloat(total_btc).toFixed(3) + ' BTC';
    document.getElementById('summaryBitcoiners').textContent      = bitcoiners;
    document.getElementById('summaryTheoreticalValue').textContent = Math.round(totalVolume).toLocaleString('de-DE') + ' â‚¬';
    document.getElementById('summaryTotalInvestment').textContent  = Math.round(total_invested).toLocaleString('de-DE') + ' â‚¬';
    document.getElementById('summaryGuaranteed').textContent       = Math.round(total_guaranteed).toLocaleString('de-DE') + ' â‚¬';

    const resEl   = document.getElementById('summaryResult');
    const resSign = portfolioResult >= 0 ? '+' : '';
    resEl.textContent = resSign + Math.round(portfolioResult).toLocaleString('de-DE') + ' â‚¬';
    resEl.style.color = portfolioResult >= 0 ? '#10b981' : '#ef4444';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Calculator
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateCalculator() {
    const growthRate = parseFloat(document.getElementById('calcGrowthRate').value) || DEFAULT_GROWTH;
    const investment = parseFloat(document.getElementById('calcInvestment').value) || 0;
    document.getElementById('calcCurrentPrice').value = currentBTCPrice.toLocaleString('de-DE') + ' â‚¬';
    const futurePrice = currentBTCPrice * Math.pow(1 + growthRate / 100, 4);
    document.getElementById('calcFuturePrice').value  = futurePrice.toFixed(0);
    if (investment > 0 && currentBTCPrice > 0) {
        const btcAmt    = investment / currentBTCPrice;
        const finalVal  = btcAmt * futurePrice;
        document.getElementById('calcFinalValue').textContent = fmt(finalVal) + ' â‚¬';
    } else {
        document.getElementById('calcFinalValue').textContent = '-- â‚¬';
    }
}

function updateGrowthRateFromPrice() {
    const futurePrice = parseFloat(document.getElementById('calcFuturePrice').value) || 0;
    const investment  = parseFloat(document.getElementById('calcInvestment').value) || 0;
    if (futurePrice > 0 && currentBTCPrice > 0) {
        const rate = (Math.pow(futurePrice / currentBTCPrice, 0.25) - 1) * 100;
        document.getElementById('calcGrowthRate').value = rate.toFixed(1);
        if (investment > 0) {
            const finalVal = (investment / currentBTCPrice) * futurePrice;
            document.getElementById('calcFinalValue').textContent = fmt(finalVal) + ' â‚¬';
        }
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Helper: format number with 2 decimals, German locale
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n) {
    return n.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Init on page load
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', async () => {
    await fetchBTCPrice();
    updateCalculator();
    loadPortfolioSummary();   // non-blocking; fills summary cards

    document.getElementById('calcGrowthRate').addEventListener('input', updateCalculator);
    document.getElementById('calcInvestment').addEventListener('input', updateCalculator);
    document.getElementById('calcFuturePrice').addEventListener('input', updateGrowthRateFromPrice);
});

// Auto-refresh every 60 s when a user is logged in
setInterval(async () => {
    const { data: { session } } = await sb.auth.getSession();
    if (session) {
        await loadDashboard(session.user);
    } else {
        await fetchBTCPrice();
        updateCalculator();
        loadPortfolioSummary();
    }
}, 60_000);
</script>
</body>
</html>
